<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>jungleweather website • jungleweather</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><!-- ropensci --><link href="bglabs.css" rel="stylesheet">
<meta property="og:title" content="jungleweather website">
<meta property="og:description" content="Explaining the Jungle Weather pre- and post-processing workflow.">
<meta name="twitter:card" content="summary">
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://bluegreenlabs.org">
          <img src="https://bluegreenlabs.org/img/logo_text_small.png" id="hexlogo" alt="bluegreen labs"></a>
        <a class="external-link hidden-md hidden-lg" href="https://bluegreenlabs.org">
          <img src="https://bluegreenlabs.org/img/logo.png" id="hexlogo" alt="bluegreen labs"></a>
        <a class="navbar-brand" href="index.html">
           <i>jungleweather <small>v0.1</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="reference/index.html">Reference</a>
</li>
        
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">


<div class="section level1">
<div class="page-header"><h1 id="the-jungle-weather-workflow">The Jungle Weather workflow<a class="anchor" aria-label="anchor" href="#the-jungle-weather-workflow"></a>
</h1></div>
<div class="section level2">
<h2 id="how-to-cite-this-package-in-your-article">How to cite this package in your article<a class="anchor" aria-label="anchor" href="#how-to-cite-this-package-in-your-article"></a>
</h2>
<p>You can cite the code in this repository like this:</p>
<blockquote>
<p>Hufkens K. (2022). The Jungle Weather workflow: facilitating data digitization <a href="https://doi.org/10.5281/zenodo.3378864" class="external-link uri">https://doi.org/10.5281/zenodo.3378864</a></p>
</blockquote>
<p>Note that all code is released under an AGPLv3 license, except for the transfer learning code which fall under an Apache license (for changes see code headers). All data, except the Burton data sheets, is (c) copyright of the COBECORE and the Belgian State Archive in particular, any re-use is NOT permitted without an explicit agreement. Any data is therefore included for testing and illustration purposes only, until a formal publication and lifting of this notice. Any use without permission will result in prosecution.</p>
<p>Note that this code comes without any guarantees. I refer to <a href="https://khufkens.com/consulting/" class="external-link">my consulting policy</a> if you need custom advice on your project, unrelated to standard bug reports.</p>
</div>
<div class="section level2">
<h2 id="use-case">Use case<a class="anchor" aria-label="anchor" href="#use-case"></a>
</h2>
<p>This repository provides the basis for the <a href="http://cobecore.org" class="external-link">COBECORE</a> based Jungle Weather project’s pre- and post-processing. However, this repository can also serve as a template for other data recovery project, especially those in which the forms used are fairly regular in nature.</p>
<p>The code base relies on python and <a href="https://opencv.org/" class="external-link">OpenCV</a> based pre-processing, including machine learning screening using <a href="https://www.tensorflow.org/" class="external-link">TensorFlow</a>. All post-processing, after annotation on Zooniverse, will be done in R. Given the convenient structure of R packages this approach is used to organize the project.</p>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The Jungle Weather workflow relies on <a href="https://en.wikipedia.org/wiki/Template_matching" class="external-link">template matching</a>. This technique is commonly used in automatic form completion and matches an existing, empty, template with a completed form. Although most historical data isn’t designed from the ground up for template matching we can leverage this technique to reduce the workload required during transcription.</p>
<p>In particular, it addresses the issue of outlining locations in a table which contain data, and reducing the complexity of the transcription. As such the workflow will generate data which only presents one value at a time for transcription, limiting the chance of propagating errors in incomplete or corrupted series. At the same time this makes the task easier to complete in informal settings, on a cellphone or a tablet rather than a computer.</p>
<p>Below you find an outline of the steps required to set up a successfull template matching routine using the code in this repository. Throughout this process I also assume a consistent naming convention in which data is grouped per site, or archival id and delimited using underscores. All images are therefore structured: <code>archive-id_scan-nr.jpg</code> a real example therefore reads 6120_057.jpg. You will need to adjust some code below if this structure will not fit your data, as the file name is used as a way to store important meta-data.</p>
</div>
<div class="section level2">
<h2 id="pre-processing">Pre-processing<a class="anchor" aria-label="anchor" href="#pre-processing"></a>
</h2>
<div class="section level3">
<h3 id="data-sorting">Data sorting<a class="anchor" aria-label="anchor" href="#data-sorting"></a>
</h3>
<p>Most historical tabulated data has a fixed format. This is a feature which I’ll leverage later on. However, to ensure that the below procedures work well it is necessary to identify all the different table formats in a dataset. Particular care should be taken to ensure that small differences are accounted for, as even font changes can lead to less desirable post-processing results.</p>
<p>Overall make sure to:</p>
<ul>
<li>check for font differences</li>
<li>check for line spacing differences</li>
<li>overall correspondence between different tables should be high</li>
</ul>
<p>In the Jungle Weather project we identified 20+ format of which three make up the bulk of all scanned data (&gt;60%).</p>
<p>It is best to sort the images using a non-destructive method. It is therefore best to use a non-destructive photo editor or manager combined with tags rather to sort the data, rather than copying the source files around. In case of the Jungle Weather we used the <a href="https://wiki.gnome.org/Apps/Shotwell" class="external-link">Shotwell photo editor and manager</a>, on Windows and OSX Adobe Lightroom might serve the same purpose.</p>
<div class="section level4">
<h4 id="time-required">time required<a class="anchor" aria-label="anchor" href="#time-required"></a>
</h4>
<p>In terms of the time required I estimate that sorting and labelling roughly 100K images would take at most a week of time. Within Jungleweather I finished the +70K images in less than a week, with a high variety of formats.</p>
</div>
</div>
<div class="section level3">
<h3 id="template-generation">Template generation<a class="anchor" aria-label="anchor" href="#template-generation"></a>
</h3>
<p>Once all different table formats are identified empty <code>templates</code> should be generated, and matching table cells annotated.</p>
<div class="section level4">
<h4 id="creating-an-empty-template">Creating an empty template<a class="anchor" aria-label="anchor" href="#creating-an-empty-template"></a>
</h4>
<p>Where possible search the dataset for an already empty table. If no empty table exist use a table with as few data points as possible. Open this (almost) empty table using an image processing software. I suggest using <a href="https://www.gimp.org/" class="external-link">GIMP</a>, as I’ll use a plugin later on to outline the cells of a table and it is freely available cross platforms.</p>
<p>Convert the this open file to a black and white template, while using the <a href="https://docs.gimp.org/2.10/en/gimp-tool-levels.html" class="external-link">levels</a> and <a href="">curves</a> to boost contrast and remove any unwanted gradients in the image. Remove all text which is not part of an empty template using the <a href="https://docs.gimp.org/2.10/en/gimp-tool-eraser.html" class="external-link">eraser</a>. The final result should look as the image below.</p>
<p><img src="http://cobecore.org/images/documentation/mask.jpg"></p>
<p>When saving these templates use a comprehensive naming scheme with a prefix and a number separated with an underscore (_) such as: “format_1.jpg” corresponding to the folder containing the image data.</p>
<pre><code>This formatting is important for successful use of the python processing code!</code></pre>
</div>
<div class="section level4">
<h4 id="outlining-table-cells">Outlining table cells<a class="anchor" aria-label="anchor" href="#outlining-table-cells"></a>
</h4>
<p>To specify the location of data within a table we will use the guides in GIMP, and a plugin to save this information. To save the guides in GIMP first install the <a href="https://github.com/khufkens/GIMP_save_load_guides" class="external-link">“save &amp; load guides plugin”</a>. After installation of the plugin (and restarting GIMP) outline all cells in a table using GIMP guides. Below you see a template with all columns outlined with vertical guides.</p>
<p><img src="http://cobecore.org/images/documentation/vertical_guides.png"></p>
<p>Once done, save the guides using the plugin (use: Image &gt; Guides &gt; Save). Make sure that the name used for the guides <strong>exactly</strong> matches the name of the image on which the guides are based. The guides will be saved in a file called “guides.txt” and stored this location: “[userfolder]/.gimp-2.8/guides/guides.txt”. Copy this file to your project folder for future processing (I store template data in a dedicated template folder containing all template images and the guides.txt file).</p>
<p>Note that you can save multiple sets of guides for multiple templates in the same guides.txt file.</p>
<div class="section level5">
<h5 id="time-required-1">time required<a class="anchor" aria-label="anchor" href="#time-required-1"></a>
</h5>
<p>Both tasks depend on the amount of formats available. In case of the COBECORE data one day was sufficient to generate all template files and associated guides.</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="automatic-template-matching">Automatic template matching<a class="anchor" aria-label="anchor" href="#automatic-template-matching"></a>
</h3>
<div class="section level4">
<h4 id="required-software">required software<a class="anchor" aria-label="anchor" href="#required-software"></a>
</h4>
<p>The pre-processing of the data depends on <a href="https://opencv.org/" class="external-link">OpenCV</a>, an open source computer vision library. As such a recent version (&gt;3) of OpenCV must be running on your system. Screening tables for empty values is done using a <a href="https://www.tensorflow.org/" class="external-link">TensorFlow</a> based classifier, and requires these libraries to be installed (a trained model is included in this repository). Standard matrix operations are done using numpy and pandas libraries. Both can be installed using the below commands, or come as defaults with your python installation.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install pip, the python package manager</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> https://bootstrap.pypa.io/get-pip.py <span class="at">-o</span> get-pip.py</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> get-pip.py</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># install pandas</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install pandas</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># install numpy</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install numpy</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># install OpenCV</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install opencv-contrib-python</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># install tensorflow (CPU)</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install tensorflow</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># for those with CUDA enabled NVIDIA cards you may use</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># pip install tensorflow-gpu</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="template-matching">template matching<a class="anchor" aria-label="anchor" href="#template-matching"></a>
</h4>
<p>The python scripts used for template matching and general pre-processing are found in <code>src</code> directory of the repository. The scripts tackle various tasks but in general should need attention. The main function is called <code>match_template.py</code> which calls the other scripts or subroutines when required. All other scripts can be run stand-alone if so desired. The latter might be useful in debugging and development.</p>
<p>The <code>match_template.py</code> script uses ORB features to match the template as generated above, to a data table with completed cell values. Below you see a visual representation of matched features (connected with lines) between a complete table on the left and an empty template on the right.</p>
<p><img src="http://cobecore.org/images/documentation/matches.jpg"></p>
<p>If good correspondence is established we can transform the image containing data to align (perfectly) with the template. Below and example is given where the transformed data is shown in red/pink tints, the template is shown as light blue, the image is dark blue where there is correspondence between both images. Note how light blue, template, header texts transition into an almost perfect correspondence with the image which contains data.</p>
<p><img src="http://cobecore.org/images/documentation/template.jpg"></p>
<p>Although the main feature of the code is focussed on matching the template with the provided data table additional functions are applied on the source data table. In particular, an inner crop is executed on the image which crops out the black boarder around scanned images in the COBECORE workflow.</p>
<p>The transformed image is subsequently divided into individual cells (with some padding to account for small misalignments) and written to disk. The code also includes screening the data for empty cells using a TensorFlow machine learning model trained on the dataset at hand. A detailed description of this routine is given below.</p>
</div>
</div>
<div class="section level3">
<h3 id="machine-learning-empty-cell-values">Machine learning empty cell values<a class="anchor" aria-label="anchor" href="#machine-learning-empty-cell-values"></a>
</h3>
<p>I use a machine (transfer) learning approach to retrain a TensorFlow based convoluted neural net (CNN) in order to detect empty cells in the historical data tables. For convenience the model is run on individual (extracted) cells rather than on the data sheet as a whole. Although the latter approach would be feasible, the workflow described above made it easier to deal with the data on a cell by cell basis.</p>
<p>For a number of data sheets the data was sorted in complete and empty cells. This data was then used in combination with the transfer learning code to train the CNN. The trained model is stored in the <code>src/cnn_model</code> directory and used when calling the <code>label_table_cell.py</code> code. The project includes a pre-trained model for reference.</p>
<p>At the end of the template matching all cells are evaluated and the results, together with a graphical preview, are written to the output directory as specified in the <code>match_template.py</code> routine. An example of the graphical preview is given below, with the colour coding the same as in the template matching example above, with the addition of white X marks for those cells flagged as empty.</p>
<p><img src="http://cobecore.org/images/documentation/alignment_preview.jpg"></p>
<p>Although the classification results aren’t 100% perfect, the general agreement is good enough to pre-screen columns, on a column by column basis.</p>
<div class="section level5">
<h5 id="time-required-2">time required<a class="anchor" aria-label="anchor" href="#time-required-2"></a>
</h5>
<p>Template matching is automated so a time requirement in terms of true man hours is pointless. Howeve, the processing of one table takes ~7 seconds. Which translates in roughly 6 days of computational time to process the digitized tables within the COBECORE project. Although performance might vary depending on the system used the expected times would be reasonable, and measured in days rather than weeks.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="post-processing">Post-processing<a class="anchor" aria-label="anchor" href="#post-processing"></a>
</h2>
<p>Although the naming of fields as output by the Zooniverse database is project specific small adjustments should make it possible to re-use the code base quickly within a different context. Unlike the pre-processing which relies on a variety of mainly python tools, the post-processing will be done exclusively in R. Meeting the requirements for processing is easier as the tools can be installed using the internal R based packaging system.</p>
<p>In order to install the R code base for this project, clone the project using:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/khufkens/jungleweather.git</span></code></pre></div>
<p>or use the <a href="https://github.com/khufkens/jungleweather/archive/master.zip" class="external-link">download link</a>.</p>
<p>With <a href="https://www.rstudio.com/" class="external-link">RStudio installed</a> open the R project by double clicking on the .Rproj file. This will open up the project in RStudio. Explore the functions in the R directory and adjust to your needs (naming conventions).</p>
<p>As the project has not produced any results yet only very basic meta-data scripts are included. More will folow as the project progresses.</p>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/AGPL-3" class="external-link">AGPL-3</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing jungleweather</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Koen Hufkens <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-5070-8109" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>BlueGreen Labs <br><small class="roles"> Copyright holder, funder </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://doi.org/10.5281/zenodo.3378864" class="external-link"><img src="https://zenodo.org/badge/DOI/10.5281/zenodo.3378864.svg" alt="DOI"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="http://github.com/bluegreen-labs" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://bluegreenlabs.org/labs/" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/bluegreen_labs" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://bluegreenlabs.org/#intro" class="external-link">BlueGreen Labs</a></li>
                            <li><a href="https://bluegreenlabs.org/#people" class="external-link">Our Team</a></li>
                            <li><a href="https://bluegreenlabs.org/#contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/bluegreen-labs" class="external-link">Packages</a></li>
                            <li><a href="https://bluegreenlabs.org/publication/" class="external-link">Publications</a></li>
                            <li><a href="https://bluegreenlabs.org/post/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>

  


  

  </body>
</html>
